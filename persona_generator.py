# persona_generator.py

import pandas as pd
import numpy as np
import random
from typing import Dict, Any

FEMALE_NAMES = ["ê¹€ì§€ì•„", "ë°•ì„œì—°", "ì´í•˜ìœ¤", "ìµœì§€ìš°", "ì •ë¯¼ì„œ"]
MALE_NAMES = ["ë°•ë„ìœ¤", "ì´ì‹œìš°", "ê¹€ì£¼ì›", "ì •ì€ìš°", "ìµœì§€í˜¸"]

PERSONA_TEMPLATES = {
    # ------------------------------------
    # 1. ì˜¤í”¼ìŠ¤ ìƒê¶Œ (ì§ì¥ì¸)
    # ------------------------------------
    'ì§ì¥ì¸_2030_ê°€ì„±ë¹„': {
        'icon': "ğŸ’¼",  
        'roles': ["ì£¼ë‹ˆì–´ ë§ˆì¼€í„°", "ì‹ ì… ê°œë°œì", "ìŠ¤íƒ€íŠ¸ì—… ì§ì›", "ì‹ ì…ì‚¬ì›"],
        'goals': ["ì ì‹¬ì‹œê°„ì— ë°–ì—ì„œ ë¨¹ìœ¼ë©° ì ì‹œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í’€ê³  ì‹¶ì–´ìš”.", 
                  "ë¹ ë¥´ê³  ê°€ì„±ë¹„ ì¢‹ì€ ì ì‹¬ ë©”ë‰´ë¥¼ ë™ë£Œë“¤ê³¼ ì°¾ê³  ìˆì–´ìš”."],
        'pain_points': ["ë§¤ì¼ íƒ•/ì°Œê°œê°€ ì§€ê²¨ì›Œìš”.", 
                        "ì ì‹¬ê°’ì´ ë„ˆë¬´ ë¶€ë‹´ë¼ìš”.",
                        "ì›¨ì´íŒ…ì´ ê¸´ ê³³ì€ ì ˆëŒ€ ê°ˆ ìˆ˜ ì—†ì–´ìš”.",
                        "íšŒì‚¬ì™€ ë„ˆë¬´ ë¨¼ ê³³ì€ ë¶€ë‹´ë¼ìš”"],
        'channels': ["ì§ì¥ë™ë£Œ ì¶”ì²œ", "ë„¤ì´ë²„ ì§€ë„ (ê°€ê²©ìˆœ)", "ì§ì¥ì¸ ìµëª… ì»¤ë®¤ë‹ˆí‹° (ë§›ì§‘)", "ì¸ìŠ¤íƒ€ê·¸ë¨"]
    },
    'ì§ì¥ì¸_4050_í”„ë¦¬ë¯¸ì—„': {
        'icon': "ğŸ‘”",  
        'roles': ["ë¶€ì¥/ì´ì‚¬ê¸‰ ê´€ë¦¬ì", "ì „ë¬¸ì§ (ë³€í˜¸ì‚¬, íšŒê³„ì‚¬)", "ì˜ì—…ì§"],
        'goals': ["ì¤‘ìš”í•œ ë¯¸íŒ…ì´ë‚˜ ì†ë‹˜ ì ‘ëŒ€ë¥¼ ìœ„í•œ í’ˆê²© ìˆëŠ” ì¥ì†Œë¥¼ ì›í•´ìš”.",
                  "í‡´ê·¼ í›„ ê¹”ë”í•œ ë¶„ìœ„ê¸°ì—ì„œ ê²©ì‹ ì—†ì´ ìˆ  í•œ ì” í•  ê³³ì´ í•„ìš”í•´ìš”."],
        'pain_points': ["ì‹œë„ëŸ½ê±°ë‚˜ ìºì£¼ì–¼í•œ ë¶„ìœ„ê¸°ëŠ” ë¶ˆí¸í•´ìš”.",
                        "ì£¼ì°¨ ê³µê°„ì´ í™•ë³´ë˜ì§€ ì•Šì€ ê³³ì€ ë°©ë¬¸í•˜ê¸° ì–´ë ¤ì›Œìš”.",
                        "ëŒ€ì¶© ë§Œë“  ë“¯í•œ ì ì‹¬ ë©”ë‰´ëŠ” ëˆì´ ì•„ê¹Œì›Œìš”."],
        'channels': ["ì§€ì¸ ì¶”ì²œ", "ë„¤ì´ë²„ ì˜ˆì•½"]
    },
    # ------------------------------------
    # 2. ì£¼ê±° ìƒê¶Œ (ê±°ì£¼ì)
    # ------------------------------------
    'ê±°ì£¼ì_ê°€ì¡±_íŒ¨ë°€ë¦¬': {
        'icon': "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",  
        'roles': ["ìœ¡ì•„ë§˜", "ì£¼ë¶€","ê°€ì¥"],
        'goals': ["ì•„ì´ë“¤ê³¼ í•¨ê»˜ í¸ì•ˆí•˜ê²Œ ì‹ì‚¬í•  ìˆ˜ ìˆëŠ” ê³µê°„ì„ ì°¾ê³  ìˆì–´ìš”.", 
                  "ì™¸ì‹ìœ¼ë¡œ ì§‘ë°¥ ê°™ì€ ê±´ê°•í•˜ê³  ë§›ìˆëŠ” í•œ ë¼ë¥¼ í•´ê²°í•˜ê³  ì‹¶ì–´ìš”.",
                  "ê°€ì¡± ë‹¤ê°™ì´ ë°–ì—ì„œ ì‹ì‚¬ë¥¼ í•˜ê³ ì‹¶ì–´ìš”"],
        'pain_points': ["ì•„ì´ ë©”ë‰´ê°€ ì—†ìœ¼ë©´ ë‚œê°í•´ìš”.",
                        "ë‹¤ë¥¸ í…Œì´ë¸”ì— í”¼í•´ë¥¼ ì¤„ê¹Œ ë´ ì¡°ìš©í•˜ì§€ ì•Šì€ ê³³ì€ êº¼ë ¤ì ¸ìš”.",
                        "ì£¼ë§ ì €ë…ì€ ì˜ˆì•½í•˜ì§€ ì•Šìœ¼ë©´ ì•‰ì„ ê³³ì´ ì—†ì–´ìš”."],
        'channels': ["ì§€ì—­ ë§˜ì¹´í˜", "ë‹¹ê·¼ë§ˆì¼“ (ë™ë„¤ìƒí™œ)", "ë°°ë‹¬ ì•± (í¬ì¥ ì£¼ë¬¸)"]
    },
    'ê±°ì£¼ì_1ì¸ê°€êµ¬_í˜¼ë°¥ì¡±': {
        'icon': "ğŸ‘¤",  
        'roles': ["ëŒ€í•™ìƒ", "ì‹±ê¸€ ì§ì¥ì¸", "ìì·¨ìƒ", "í”„ë¦¬ëœì„œ"],
        'goals': ["ì§‘ ê·¼ì²˜ì—ì„œ í˜¼ì ë¶€ë‹´ ì—†ì´ ê°„ë‹¨í•˜ê²Œ ë¼ë‹ˆë¥¼ ë•Œìš°ê³  ì‹¶ì–´ìš”.",
                  "ì£¼ë§ì— ì†Œì†Œí•˜ê²Œ íë§í•  ìˆ˜ ìˆëŠ” 'ë‚˜ë§Œì˜ ì•„ì§€íŠ¸' ê°™ì€ ê³µê°„ì„ ì°¾ì•„ìš”."],
        'pain_points': ["í˜¼ì ë°©ë¬¸í•˜ê¸° ì–´ìƒ‰í•œ ë¶„ìœ„ê¸°ì˜ ì‹ë‹¹ì´ ë„ˆë¬´ ë§ì•„ìš”.",
                        "ì–‘ì´ ë„ˆë¬´ ë§ì•„ì„œ ë‚¨ê¸°ê²Œ ë ê¹Œ ë´ ê±±ì •ë¼ìš”.",
                        "ë°°ë‹¬ë¹„ê°€ ë¹„ì‹¸ì„œ í¬ì¥/ë°©ë¬¸ì„ ì´ìš©í•˜ê³  ì‹¶ì–´ìš”."],
        'channels': ["ë„¤ì´ë²„ ì§€ë„ (ë‚´ ì£¼ë³€)", "ì¸ìŠ¤íƒ€ê·¸ë¨ (í˜¼ë°¥ í•´ì‹œíƒœê·¸)", "ìœ íŠœë¸Œ (ìì·¨ VLOG,ë¨¹ë°©)"]
    },
    # ------------------------------------
    # 3. ê¸°íƒ€/ìœ ë™ì¸êµ¬ (íƒìƒ‰)
    # ------------------------------------
    'ìœ ë™ì¸êµ¬_ê´€ê´‘_íƒìƒ‰í˜•': {
        'icon': "ğŸ‘¥", 
        'roles': ["ì—¬í–‰ê°", "íƒ€ì§€ ë°©ë¬¸ê°", "ë°ì´íŠ¸ ì»¤í”Œ"],
        'goals': ["ì´ ì§€ì—­ì—ì„œ ê¼­ ë¨¹ì–´ì•¼ í•˜ëŠ” 'ì‹œê·¸ë‹ˆì²˜' ë©”ë‰´ë¥¼ ë§›ë³´ê³  ì‹¶ì–´ìš”.",
                  "ì‚¬ì§„ ì°ê¸° ì¢‹ì€ ì˜ˆìœ ì¥ì†Œì—ì„œ ê²½í—˜ì„ ê³µìœ í•˜ê³  ì‹¶ì–´ìš”."],
        'pain_points': ["ì •ë³´ê°€ ë„ˆë¬´ ë§ì•„ì„œ ë§›ì§‘ì„ ê³ ë¥´ê¸° ì–´ë ¤ì›Œìš”.",
                        "ìœ ëª…í•œ ê³³ì€ ëŒ€ê¸°ê°€ ë„ˆë¬´ ê¸¸ì–´ ì‹œê°„ì„ ë‚­ë¹„í•´ìš”.",
                        "SNS í›„ê¸°ë§Œ ë¯¿ê³  ê°”ë‹¤ê°€ ì‹¤ë§í•œ ê²½í—˜ì´ ë§ì•„ìš”."],
        'channels': ["ì¸ìŠ¤íƒ€ê·¸ë¨ (ì§€ì—­ëª… í•´ì‹œíƒœê·¸)", "ë¸”ë¡œê·¸ (ìµœì‹  í›„ê¸°)", "ìºì¹˜í…Œì´ë¸”", "ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤", "ì¹´ì¹´ì˜¤ë§µ ë¦¬ë·°"]
    },
    'ìœ ë™ì¸êµ¬_ëŒ€ì¤‘êµí†µ_í™˜ìŠ¹ê°': {
        'icon': "ğŸš†", 
        'roles': ["ì¶œí‡´ê·¼ í™˜ìŠ¹ê°", "ì•½ì† ì „ ì‹œê°„ ë•Œìš°ëŠ” ì‚¬ëŒ", "ê¸‰í•œ ì¼ì •ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ë§¨"],
        'goals': ["ì•½ì† ì¥ì†Œë¡œ ì´ë™í•˜ê¸° ì „ì— ë¹ ë¥´ê³  ê°„ë‹¨í•˜ê²Œ ì‹ì‚¬ë¥¼ í•´ê²°í•˜ê³  ì‹¶ì–´ìš”.",
                  "ëŒ€ê¸° ì—†ì´ ë°”ë¡œ ì´ìš© ê°€ëŠ¥í•œ ì¹´í˜ë‚˜ ì‹ë‹¹ì´ í•„ìš”í•´ìš”."],
        'pain_points': ["ì—­ ê·¼ì²˜ëŠ” ë„ˆë¬´ ë¶ë¹„ê³  ì •ì‹ ì´ ì—†ì–´ìš”.",
                        "ì»¤í”¼ í•œ ì”ë§Œ ì‹œí‚¤ê¸° ëˆˆì¹˜ ë³´ì´ëŠ” ê³³ì€ ì‹«ì–´ìš”.",
                        "í™”ì¥ì‹¤ì´ ê¹¨ë—í•˜ì§€ ì•Šì€ ê³³ì€ ë¶ˆí¸í•´ìš”."],
        'channels': ["ë„¤ì´ë²„ ì§€ë„ (í˜„ì¬ ìœ„ì¹˜, ë¹ ë¥¸ ê²€ìƒ‰)", "ì¹´ì¹´ì˜¤ë§µ", "ëŒ€ì¤‘êµí†µ ì»¤ë®¤ë‹ˆí‹°"]
    }
}

def create_persona(merchant_row: pd.Series, analysis_summary: Dict[str, Any]) -> Dict[str, Any]:
    """
    ë°ì´í„° ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°€ìƒì˜ ê³ ê° í˜ë¥´ì†Œë‚˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    # 1. ë¶„ì„ ê²°ê³¼ ì¶”ì¶œ
    info = analysis_summary['static_info']
    dominant_ag_group = analysis_summary['dominant_ag_group']
    primary_cust_type = analysis_summary['primary_cust_type']    
    
    gender = 'ì—¬ì„±' if 'ì—¬ì„±' in dominant_ag_group else 'ë‚¨ì„±'
    age_group = dominant_ag_group.replace('ë‚¨ì„± ', '').replace('ì—¬ì„± ', '')
    age_code = age_group.split('ëŒ€')[0] 
    
    name = random.choice(FEMALE_NAMES) if gender == 'ì—¬ì„±' else random.choice(MALE_NAMES)

    # 2. ê°€ê²Œ íŠ¹ì§• íŒŒì•…
    avg_price = analysis_summary.get('RC_M1_AV_NP_AT', 0)
    is_premium = avg_price > analysis_summary.get('RC_M1_BZN_AV_NP_AT', 0) * 1.2
    
    # 3. í˜ë¥´ì†Œë‚˜ ìœ í˜• ê²°ì • ë¡œì§
    persona_key = ""

    if primary_cust_type == 'ì§ì¥':
        if age_code in ['20', '30'] or not is_premium:
            persona_key = 'ì§ì¥ì¸_2030_ê°€ì„±ë¹„'
        elif age_code in ['40', '50'] and is_premium:
            persona_key = 'ì§ì¥ì¸_4050_í”„ë¦¬ë¯¸ì—„'
        else:
            persona_key = 'ì§ì¥ì¸_2030_ê°€ì„±ë¹„'
            
    elif primary_cust_type == 'ê±°ì£¼':
        if info.get('HPSN_MCT_BZN_CD_NM') in ['ì£¼íƒê°€']:
            if age_code in ['40', '50'] and gender == 'ì—¬ì„±':
                persona_key = 'ê±°ì£¼ì_ê°€ì¡±_íŒ¨ë°€ë¦¬'
            elif age_code in ['20', '30'] and analysis_summary.get('MCT_UE_CLN_NEW_RAT', 0) > 0.6:
                persona_key = 'ê±°ì£¼ì_1ì¸ê°€êµ¬_í˜¼ë°¥ì¡±'
            else:
                persona_key = 'ê±°ì£¼ì_ê°€ì¡±_íŒ¨ë°€ë¦¬'
        else: # ì£¼íƒê°€ê°€ ì•„ë‹ˆë©´ 1ì¸ ê°€êµ¬ë¡œ ê¸°ë³¸ ì„¤ì •
            persona_key = 'ê±°ì£¼ì_1ì¸ê°€êµ¬_í˜¼ë°¥ì¡±'
                
    elif primary_cust_type == 'ìœ ë™ì¸êµ¬':
        if info.get('HPSN_MCT_BZN_CD_NM') in ['ê´€ê´‘íŠ¹êµ¬', 'ëª…ì†Œ', 'ë³µí•©ë‹¨ì§€']:
            persona_key = 'ìœ ë™ì¸êµ¬_ê´€ê´‘_íƒìƒ‰í˜•'
        elif info.get('HPSN_MCT_BZN_CD_NM') in ['ì—­ì„¸ê¶Œ']:
            persona_key = 'ìœ ë™ì¸êµ¬_ëŒ€ì¤‘êµí†µ_í™˜ìŠ¹ê°'
        else:
            persona_key = 'ìœ ë™ì¸êµ¬_ê´€ê´‘_íƒìƒ‰í˜•'
    
    # 4. í…œí”Œë¦¿ ë¡œë“œ ë° êµ¬ì²´í™”
    if not persona_key:
        persona_key = 'ì§ì¥ì¸_2030_ê°€ì„±ë¹„' 
    template = PERSONA_TEMPLATES[persona_key]
    
    job = random.choice(template['roles'])
    
    # 5. í˜ë¥´ì†Œë‚˜ì˜ ëª©í‘œ(Goals)ì™€ ì–´ë ¤ì›€(Pain Points) ì„¤ì •
    pain_points = random.sample(template['pain_points'], 2)
    
    if 'ì¬ë°©ë¬¸ ê³ ê° ë¹„ì¤‘ì´ ë‚®ì•„' in analysis_summary.get('retention_analysis_text', ''):
        pain_points.append("ë§ˆìŒì— ë“œëŠ” ê°€ê²Œë¥¼ ì°¾ìœ¼ë©´ ì •ì°©í•˜ê³  ì‹¶ì§€ë§Œ, ì•„ì§ ë‹¨ê³¨ì´ ë  ë§Œí¼ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ê³³ì„ ë°œê²¬í•˜ì§€ ëª»í–ˆì–´ìš”.")

    # 6. í˜ë¥´ì†Œë‚˜ ì¢…í•© ì •ë³´ ìƒì„±
    persona_description = (
    f"<b>{name}</b> ë‹˜ì€ <b>{age_group} {gender}</b> ìœ¼ë¡œ, ì§ì—…ì€ <b>{job}</b> ì…ë‹ˆë‹¤. "
    f"ì£¼ë¡œ '<b>{info.get('h_name', info.get('HPSN_MCT_BZN_CD_NM'))}</b>' ìƒê¶Œì—ì„œ í™œë™í•˜ë©°, "
    f"ê°€ê²Œì˜ ì „ì²´ ê³ ê° ì¤‘ <b>{analysis_summary['dominant_ag_ratio']:.1f}%</b> ë¥¼ ì°¨ì§€í•˜ëŠ” í•µì‹¬ ê³ ê° ê·¸ë£¹ì„ ëŒ€í‘œí•©ë‹ˆë‹¤."
)
    
    return {
        'icon': template['icon'],
        'name': f"{name} ({job} / {age_group} {gender})",
        'description': persona_description,
        'goals': random.sample(template['goals'], 2),
        'pain_points': pain_points,
        'channels': template['channels']
    }
