# clustering.py
import os
import pandas as pd
from functools import lru_cache
from data_processor import FIXED_DATA_PATH

DTW_REL_PATH = "dtw_clustering.csv"

DTW_LABELS = {
    # ğŸš€ ì‹ í¥ ê³ ì„±ì¥ ê·¸ë£¹ (User's Cluster 3)
    "3": {
        "name": 'ì‹ í¥ ê³ ì„±ì¥ ê·¸ë£¹ ("íŠ¸ë Œë“œì„¸í„°")',
        "tone": "success",
        "icon": "ğŸš€",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": (
            "**íŒ¨í„´ (What):**\n"
            "- ìœ ì¼í•˜ê²Œ í­ë°œì ì¸ ìš°ìƒí–¥ì„ ê·¸ë¦½ë‹ˆë‹¤.\n"
            "- í•µì‹¬ì€ ì‹ ê·œ ê³ ê° ë¹„ìœ¨ì´ ì´ˆê¸°ì— ë†’ì•˜ë‹¤ê°€ ì¬ë°©ë¬¸ìœ¨ì´ ì´ë¥¼ ê³¨ë“  í¬ë¡œìŠ¤í•˜ë©° ì—­ì „í•˜ëŠ”, ê°€ì¥ ì´ìƒì ì¸ ì„±ì¥ ê³¡ì„ ì„ ë³´ì…ë‹ˆë‹¤."
        ),
        "interpretation": (
            "**ì„¸ë¶€ ë¶„ì„ (Why):**\n"
            "- **í•µì‹¬ ê³ ê°:** 30ëŒ€ ì—¬ì„± ë¹„ìœ¨ê³¼ 10-20ëŒ€ ì—¬ì„± ë¹„ìœ¨ì´ 4ê°œ êµ°ì§‘ ì¤‘ ê°€ì¥ ë†’ìŠµë‹ˆë‹¤.\n"
            "- **ê³ ê° ìœ í˜•:** ìœ ë™ì¸êµ¬ ê³ ê° ë¹„ìœ¨ì´ ì••ë„ì ìœ¼ë¡œ ë†’ìŠµë‹ˆë‹¤.\n"
            "- **ìš´ì˜ ì „ëµ:** ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨ì´ 4ê°œ êµ°ì§‘ ì¤‘ ê°€ì¥ ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n\n"
            '**ê²°ë¡  (Persona): "íŠ¸ë Œë“œë¥¼ ì„ ë„í•˜ëŠ” ë””ì§€í„¸ ë„¤ì´í‹°ë¸Œ ìƒì "**\n\n'
            "ì´ ê·¸ë£¹ì€ 30ëŒ€ ì´í•˜ ì—¬ì„±ì„ í•µì‹¬ íƒ€ê²Ÿìœ¼ë¡œ, ì¸ìŠ¤íƒ€ê·¸ë¨ ë“± SNS ë§ˆì¼€íŒ…ì„ í†µí•´ ì™¸ë¶€ ìœ ë™ì¸êµ¬ë¥¼ ì‹ ê·œ ê³ ê°ìœ¼ë¡œ ëŒ€ê±° ìœ ì¹˜í•˜ëŠ” ë° ì„±ê³µí–ˆìŠµë‹ˆë‹¤. "
            "ë‹¨ìˆœ ìœ ì…ì— ê·¸ì¹˜ì§€ ì•Šê³ , ì°¨ë³„í™”ëœ ë§›ê³¼ ê²½í—˜ì„ ì œê³µí•˜ì—¬ ì´ë“¤ì„ ì¶©ì„± ê³ ê°(ì¬ë°©ë¬¸)ìœ¼ë¡œ ì „í™˜ì‹œì¼°ìœ¼ë©°, ë°°ë‹¬(ë””ì§€í„¸ ì „í™˜)ì—ë„ ê°€ì¥ ì ê·¹ì ìœ¼ë¡œ ëŒ€ì‘í•˜ì—¬ ì„±ì¥ì„ ê·¹ëŒ€í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤."
        ),
        "key_industries": (
            "**ì—…ì¢… (Who):**\n"
            "ì»¤í”¼ì „ë¬¸ì , ì¹´í˜, ë² ì´ì»¤ë¦¬ ë“± íŠ¸ë Œë“œì™€ SNS ë°”ì´ëŸ´ì— ê°€ì¥ ë¯¼ê°í•œ ì—…ì¢…ì´ ì••ë„ì ìœ¼ë¡œ ë§ìŠµë‹ˆë‹¤."
        )
    },
    # ğŸ’ ì••ë„ì ì¸ ì´ˆìš°ëŸ‰ ê·¸ë£¹ (User's Cluster 0)
    "0": {
        "name": 'ì‹ í¥ ê³ ì„±ì¥ ê·¸ë£¹ ("íŠ¸ë Œë“œì„¸í„°")',
        "tone": "info",
        "icon": "ğŸ’",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": (
            "**íŒ¨í„´ (What):**\n"
            "- ë‹¤ë¥¸ ëª¨ë“  ê·¸ë£¹ì„ ì••ë„í•˜ëŠ” ê°€ì¥ ë†’ì€ ìˆ˜ì¤€ì˜ ë§¤ì¶œê³¼ ê³ ê° ìˆ˜ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.\n"
            "- ì¬ë°©ë¬¸ìœ¨(REU_RAT)ì´ ê·¹ë„ë¡œ ë†’ì•„ ê°•ë ¥í•œ 'ê²½ì œì  í•´ì'ë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤."
        ),
        "interpretation": (
            "**ì„¸ë¶€ ë¶„ì„ (Why):**\n"
            "- **í•µì‹¬ ê³ ê°:** ëª¨ë“  ì¸êµ¬í†µê³„ê°€ ê³ ë¥´ê²Œ ë°œë‹¬í•´ ìˆìŠµë‹ˆë‹¤. íŠ¹ì • ì—°ë ¹/ì„±ë³„ì— ì¹˜ìš°ì¹˜ì§€ ì•Šê³  ì „ ê³ ê°ì¸µì„ í¡ìˆ˜í•©ë‹ˆë‹¤.\n"
            "- **ê³ ê° ìœ í˜•:** ìœ ë™ì¸êµ¬, ê±°ì£¼ë¯¼, ì§ì¥ì¸ ë¹„ìœ¨ì´ ëª¨ë‘ ë†’ì€ ìˆ˜ì¤€ì—ì„œ ê· í˜•ì„ ì´ë£¹ë‹ˆë‹¤.\n"
            "- **ìš´ì˜ ì „ëµ:** ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨ì´ 4ê°œ êµ°ì§‘ ì¤‘ ê°€ì¥ ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n\n"
            '**ê²°ë¡  (Persona): "ìƒê¶Œì„ ëŒ€í‘œí•˜ëŠ” ëŒ€ì²´ ë¶ˆê°€ëŠ¥í•œ ë¸Œëœë“œ"**\n\n'
            "ì´ ê·¸ë£¹ì€ íŠ¹ì • ì—…ì¢…ì´ë‚˜ ê³ ê°ì¸µì— ì˜ì¡´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¯¸ 'ìƒê¶Œì„ ëŒ€í‘œí•˜ëŠ” ëœë“œë§ˆí¬' ë˜ëŠ” 'ëŒ€ì²´ ë¶ˆê°€ëŠ¥í•œ ë¸Œëœë“œ'ë¡œ ìë¦¬ ì¡ì•„, ëª¨ë“  ìœ í˜•ì˜ ê³ ê°(ê±°ì£¼/ì§ì¥/ìœ ë™)ê³¼ ëª¨ë“  ì—°ë ¹ì¸µì„ ëŒì–´ëª¨ìë‹ˆë‹¤. ì´ë¯¸ ê²½ìŸì˜ ë‹¨ê³„ë¥¼ ì´ˆì›”í•˜ì—¬ ì‹œì¥ ìì²´ë¥¼ ì§€ë°°í•˜ê³  ìˆëŠ” ê·¸ë£¹ì…ë‹ˆë‹¤."
        ),
        "key_industries": (
            "**ì—…ì¢… (Who):**\n"
            "ì»¤í”¼ì „ë¬¸ì , í•œì‹-ë‹¨í’ˆìš”ë¦¬ì¼ë°˜, í¬ì¥ë§ˆì°¨, ì²­ê³¼ë¬¼ ë“± ì—…ì¢…ì„ ê°€ë¦¬ì§€ ì•Šê³  ë‹¤ì–‘í•œ ë¶„ì•¼ì˜ 1ë“± ìƒì ë“¤ì´ í¬ì§„í•´ ìˆìŠµë‹ˆë‹¤."
        )
    },

    # âš ï¸ ì‡ í‡´/ê²½ìŸ ë„íƒœ ê·¸ë£¹ (User's Cluster 2)
    "2": {
        "name": 'ì‡ í‡´/ê²½ìŸ ë„íƒœ ê·¸ë£¹ ("ìœ„ê¸°ì˜ ìƒì ")',
        "tone": "warning",
        "icon": "âš ï¸",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": (
            "**íŒ¨í„´ (What):**\n"
            "- 4ê°œ ê·¸ë£¹ ì¤‘ ìœ ì¼í•˜ê²Œ ë§¤ì¶œê³¼ ê³ ê° ìˆ˜ê°€ ëšœë ·í•œ ìš°í•˜í–¥ì„ ê·¸ë¦½ë‹ˆë‹¤.\n"
            "- ì¬ë°©ë¬¸ìœ¨ê³¼ ì‹ ê·œ ìœ ì…ë¥  ëª¨ë‘ í™œë ¥ì„ ìƒê³  ë™ë°˜ í•˜ë½í•©ë‹ˆë‹¤."
        ),
        "interpretation": (
            "**ì„¸ë¶€ ë¶„ì„ (Why):**\n"
            "- **í•µì‹¬ ê³ ê°:** Cluster 3ê³¼ ë¹„êµí–ˆì„ ë•Œ, í•µì‹¬ íƒ€ê²Ÿì¸ 30ëŒ€ ì—¬ì„± ë¹„ìœ¨ì´ í˜„ì €íˆ ë‚®ìŠµë‹ˆë‹¤. ë°˜ë©´, ê³ ê°ì¸µì´ ë¶ˆëª…í™•í•˜ê³  ë¶„ì‚°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n"
            "- **ê³ ê° ìœ í˜•:** Cluster 3ë³´ë‹¤ ìœ ë™ì¸êµ¬ ë¹„ìœ¨ì´ ë‚®ê³ , ê·¸ë ‡ë‹¤ê³  Cluster 1ì²˜ëŸ¼ ê±°ì£¼ë¯¼/ì§ì¥ì¸ ë¹„ìœ¨ì´ ë†’ì§€ë„ ì•Šì€, ì–´ì¤‘ê°„í•œ ê³ ê° êµ¬ì„±ì„ ë³´ì…ë‹ˆë‹¤.\n"
            "- **ìš´ì˜ ì „ëµ:** ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨ì´ Cluster 3(ê³ ì„±ì¥ ê·¸ë£¹)ë³´ë‹¤ í›¨ì”¬ ë‚®ìŠµë‹ˆë‹¤.\n\n"
            '**ê²°ë¡  (Persona): "íŠ¸ë Œë“œì™€ ë””ì§€í„¸ ì „í™˜ì— ëª¨ë‘ ì‹¤íŒ¨í•œ ìƒì "**\n\n'
            "ì´ ê·¸ë£¹ì€ 'ì–´ë–»ê²Œ' ì‹¤íŒ¨í–ˆëŠ”ì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. Cluster 3ê³¼ ê°™ì€ ì»¤í”¼/ì¹´í˜ ì—…ì¢…ì„ì—ë„ ë¶ˆêµ¬í•˜ê³ , (1) íŠ¸ë Œë“œë¥¼ ì£¼ë„í•˜ëŠ” 30ëŒ€ ì—¬ì„± í•µì‹¬ ê³ ê°ì„ ë¹¼ì•—ê¸°ê³ , (2) ë°°ë‹¬ê³¼ ê°™ì€ ë””ì§€í„¸ ì „í™˜ì— ëŒ€ì‘í•˜ì§€ ëª»í–ˆìœ¼ë©°, (3) Cluster 1ì²˜ëŸ¼ í™•ì‹¤í•œ ì§€ì—­ ë‹¨ê³¨ì„ í™•ë³´í•˜ì§€ë„ ëª»í•˜ë©´ì„œ ì–‘ìª½ ëª¨ë‘ì—ê²Œì„œ ê²½ìŸë ¥ì„ ìƒê³  ì‡ í‡´í•˜ê³  ìˆìŠµë‹ˆë‹¤."
        ),
        "key_industries": (
            "**ì—…ì¢… (Who):**\n"
            "ì»¤í”¼ì „ë¬¸ì , ì¹´í˜, í•œì‹-ë‹¨í’ˆìš”ë¦¬ì¼ë°˜ì´ ë§ìŠµë‹ˆë‹¤. ì‹ í¥ ê³ ì„±ì¥ ê·¸ë£¹ê³¼ ì—…ì¢…ì´ ê²¹ì¹œë‹¤ëŠ” ì ì´ í•µì‹¬ì…ë‹ˆë‹¤."
        )
    },
    # ğŸ¦ ì•ˆì •ì ì¸ ì¤‘ê²¬ ê·¸ë£¹ (User's Cluster 1)
    "1": {
        "name": 'ì•ˆì •ì ì¸ ì¤‘ê²¬ ê·¸ë£¹ ("ì§€ì—­ í„°ì¤ëŒ€ê°")',
        "tone": "primary",
        "icon": "ğŸ¦",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": (
            "**íŒ¨í„´ (What):**\n"
            "- ì¤‘ê°„ ìˆ˜ì¤€ ì´ìƒì˜ ë§¤ì¶œê³¼ ê³ ê° ìˆ˜ë¥¼ í° ë³€ë™ ì—†ì´ ê¾¸ì¤€íˆ ìœ ì§€í•©ë‹ˆë‹¤.\n"
            "- ì¬ë°©ë¬¸ìœ¨ì´ ì‹ ê·œ ìœ ì…ë¥ ë³´ë‹¤ ì¼ê´€ë˜ê²Œ ë†’ì•„, ì´ë¯¸ ì•ˆì •ì ì¸ ê¶¤ë„ì— ì˜¬ëìŒì„ ë³´ì—¬ì¤ë‹ˆë‹¤."
        ),
        "interpretation": (
            "**ì„¸ë¶€ ë¶„ì„ (Why):**\n"
            "- **í•µì‹¬ ê³ ê°:** 40ëŒ€ ë‚¨ì„± ë¹„ìœ¨ê³¼ 50ëŒ€ ë‚¨ì„± ë¹„ìœ¨ì´ 4ê°œ êµ°ì§‘ ì¤‘ ê°€ì¥ ë†’ìŠµë‹ˆë‹¤.\n"
            "- **ê³ ê° ìœ í˜•:** ì§€ì—­ ê±°ì£¼ë¯¼ ë¹„ìœ¨ê³¼ ì§ì¥ì¸ ê³ ê° ë¹„ìœ¨ì´ ë§¤ìš° ë†’ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n"
            "- **ìš´ì˜ ì „ëµ:** ë°°ë‹¬ ë§¤ì¶œ ë¹„ìœ¨ì€ ìƒëŒ€ì ìœ¼ë¡œ ë‚®ìŠµë‹ˆë‹¤.\n\n"
            '**ê²°ë¡  (Persona): "ì§ì¥ì¸/ê±°ì£¼ë¯¼ ë‹¨ê³¨ì„ í™•ë³´í•œ ë¡œì»¬ ë§›ì§‘"**\n\n'
            "ì´ ê·¸ë£¹ì€ 40-50ëŒ€ ë‚¨ì„±ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•œ ì§€ì—­ ì§ì¥ì¸ê³¼ ê±°ì£¼ë¯¼ì„ í•µì‹¬ ê³ ê°ìœ¼ë¡œ í™•ë³´í•˜ê³  ìˆìŠµë‹ˆë‹¤. "
            "íŠ¸ë Œë“œë‚˜ ìœ ë™ì¸êµ¬ë³´ë‹¤ëŠ”, ì ì‹¬/ì €ë… ì‹ì‚¬ ë° íšŒì‹ì„ ìœ„í•œ 'ë‹¨ê³¨ ì¥ì‚¬'ì— íŠ¹í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìœ í–‰ê³¼ ë¬´ê´€í•˜ê²Œ ê°•ë ¥í•œ ë¡œì»¬ ê³ ê°ì¸µì„ ê¸°ë°˜ìœ¼ë¡œ ì•ˆì •ì ì¸ ì‹¤ì ì„ ë‚´ëŠ” ìƒê¶Œì˜ 'í—ˆë¦¬'ì…ë‹ˆë‹¤."
        ),
        "key_industries": (
            "**ì—…ì¢… (Who):**\n"
            "í•œì‹-ë‹¨í’ˆìš”ë¦¬ì¼ë°˜, ìš”ë¦¬ì£¼ì , í•œì‹-ìœ¡ë¥˜/ê³ ê¸° ë“± ì§€ì—­ ê¸°ë°˜ì˜ ì „í†µì ì¸ ì™¸ì‹ì—…ì´ ì£¼ë¥¼ ì´ë£¹ë‹ˆë‹¤."
        )
    },
}


@lru_cache(maxsize=1)
def load_dtw_table() -> pd.DataFrame:
    base_dir = os.path.dirname(FIXED_DATA_PATH)
    csv_path = os.path.join(base_dir, DTW_REL_PATH)
    df = pd.read_csv(csv_path, encoding="euc-kr")
    df["ENCODED_MCT"] = df["ENCODED_MCT"].astype(str)
    df["dtw_cluster"] = df["dtw_cluster"].astype(str)
    return df

def get_dtw_cluster(mct_id: str) -> str | None:
    if not mct_id:
        return None
    df = load_dtw_table()
    row = df.loc[df["ENCODED_MCT"] == str(mct_id)]
    return None if row.empty else row.iloc[0]["dtw_cluster"]

def build_dtw_report(mct_id: str, merchant_name: str) -> dict:
    dtw = load_dtw_table()
    my_cluster = get_dtw_cluster(mct_id)
    label = DTW_LABELS.get(str(my_cluster), {
        "name": "ë¯¸ì •", "tone": "secondary", "icon": "â„¹ï¸",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": ["êµ°ì§‘ ë¼ë²¨ ë§¤í•‘ ì¤€ë¹„ ì¤‘"],
        "interpretation": "ì¶”ê°€ ë°ì´í„° í•„ìš”.",
        "key_industries": "-"
    })


    intro_title = "ì„±ë™êµ¬ë‚´ ì—…ì¥ê³¼ ë‚´ ì—…ì¥ ë¹„êµë¶„ì„ ì„œë¹„ìŠ¤ â¤ï¸"
    intro_body = (
        "ì„±ë™êµ¬ ë‚´ì—ì„œ ë§¤ì¶œ, ê³ ê° ìˆ˜ ë“± ë³€í™” íŒ¨í„´ì´ ë¹„ìŠ·í•œ ê·¸ë£¹ë“¤ì„ ë¹„êµë¶„ì„í•œ ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦´ê²Œìš”. ğŸ˜‹<br>"
        f"ì ì£¼ë‹˜ì˜ ì—…ì¥ì€ ì„±ë™êµ¬ ë‚´ì—ì„œ <b>[{label['name']}]</b>ì— í•´ë‹¹í•˜ë„¤ìš”!"
    )

    image_path = f"./data/plots/dtw_cluster_{my_cluster}.png"
    images = [image_path] if os.path.exists(image_path) else []

    return {
        "intro_title": intro_title,
        "intro_body": intro_body,
        "cluster_badge": {"name": label["name"], "tone": label["tone"], "icon": label["icon"]},
        "notes": "DTW ê¸°ë°˜ Clustering ê²°ê³¼ ì œì‹œ",
        "pattern": label["pattern"],
        "interpretation": label["interpretation"],
        "key_industries": label["key_industries"],
        "images": images,
        "meta": {"model_ver": "dtw_v1", "data_source": DTW_REL_PATH}
    }
