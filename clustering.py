# clustering.py
import os
import pandas as pd
from functools import lru_cache
from data_processor import FIXED_DATA_PATH

DTW_REL_PATH = "dtw_clustering.csv"

DTW_LABELS = {
    "0": {"name": "ê³ ì„±ì¥ ê·¸ë£¹", "tone": "success", "icon": "ğŸš€",
          "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.",
          "pattern": [
              "ë§¤ì¶œ(SAA) ë° ê³ ê° ìˆ˜(CUS_CN): ê°€íŒŒë¥¸ ìš°ìƒí–¥ ì¶”ì„¸ê°€ ë§¤ìš° ëšœë ·í•©ë‹ˆë‹¤.",
              "ì‹ ê·œ ê³ ê° ë¹„ìœ¨(NEW_RAT): ì´ˆê¸°ì— ë§¤ìš° ë†’ì•˜ë‹¤ê°€ ì ì°¨ ì•ˆì •í™”ë©ë‹ˆë‹¤.",
              "ì¬ë°©ë¬¸ìœ¨(REU_RAT): ê¾¸ì¤€íˆ ìƒìŠ¹í•˜ë©° ì‹ ê·œ ê³ ê° ë¹„ìœ¨ê³¼ êµì°¨í•©ë‹ˆë‹¤."
          ],
          "interpretation": "ìƒˆë¡­ê²Œ ë– ì˜¤ë¥´ëŠ” ì¸ê¸° ìƒì  ê·¸ë£¹ì…ë‹ˆë‹¤. ì´ˆê¸°ì— ì‹ ê·œ ê³ ê°ì„ ì„±ê³µì ìœ¼ë¡œ ëŒ€ê±° ìœ ì¹˜í•˜ê³ , ê·¸ ê³ ê°ë“¤ì„ ì¶©ì„± ê³ ê°ìœ¼ë¡œ ì „í™˜ì‹œí‚¤ë©´ì„œ í­ë°œì ì¸ ì„±ì¥ì„ ì´ë¤„ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ê°€ì¥ ì´ìƒì ì¸ ì„±ì¥ ê³¡ì„ ì„ ê·¸ë¦¬ê³  ìˆëŠ” ê·¸ë£¹ì…ë‹ˆë‹¤.",
          "key_industries": "ì»¤í”¼ì „ë¬¸ì , ì¹´í˜, ë² ì´ì»¤ë¦¬ ë“± íŠ¸ë Œë“œì— ë¯¼ê°í•˜ê³  ì…ì†Œë¬¸ì„ í†µí•´ ë¹ ë¥´ê²Œ ì„±ì¥í•  ìˆ˜ ìˆëŠ” ì—…ì¢…ë“¤ì´ ì£¼ë¡œ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."},
    "1": {"name": "ì•ˆì •ì ì¸ ìš°ëŸ‰ ê·¸ë£¹", "tone": "info", "icon": "ğŸ’",
          "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.",
          "pattern": [
              "ë§¤ì¶œ(SAA) ë° ê³ ê° ìˆ˜(CUS_CN): ë†’ì€ ìˆ˜ì¤€ì—ì„œ í° ë³€ë™ ì—†ì´ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.",
              "ì‹ ê·œ ê³ ê° ë¹„ìœ¨(NEW_RAT): ë‚®ê³  ì•ˆì •ì ì¸ ìˆ˜ì¤€ì„ ìœ ì§€í•©ë‹ˆë‹¤.",
              "ì¬ë°©ë¬¸ìœ¨(REU_RAT): ë§¤ìš° ë†’ì€ ìˆ˜ì¤€ì—ì„œ ê¾¸ì¤€íˆ ìœ ì§€ë©ë‹ˆë‹¤."
          ],
          "interpretation": "ì´ë¯¸ ìë¦¬ë¥¼ ì¡ì€ í•µì‹¬ ìš°ëŸ‰ ìƒì  ê·¸ë£¹ì…ë‹ˆë‹¤. ê°•ë ¥í•œ ì¶©ì„± ê³ ê°ì¸µì„ ë°”íƒ•ìœ¼ë¡œ ê¾¸ì¤€í•˜ê³  ì•ˆì •ì ì¸ ì‹¤ì ì„ ë‚´ê³  ìˆìŠµë‹ˆë‹¤. ì‹œì¥ ë³€í™”ì— í¬ê²Œ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ì €ë ¥ì„ ê°€ì§„ ê·¸ë£¹ì…ë‹ˆë‹¤.",
          "key_industries": "í•œì‹-ë‹¨í’ˆìš”ë¦¬ì¼ë°˜, ìš”ë¦¬ì£¼ì , í•œì‹-ìœ¡ë¥˜/ê³ ê¸° ë“± ë‹¨ê³¨ ê³ ê°ì´ ì¤‘ìš”í•œ ì „í†µì ì¸ ì™¸ì‹ì—…ì¢…ì´ ë‹¤ìˆ˜ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."},
    "2": {"name": "ì‡ í‡´/ìœ„í—˜ ê·¸ë£¹", "tone": "warning", "icon": "âš ï¸",
          "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.",
          "pattern": [
              "ë§¤ì¶œ(SAA) ë° ê³ ê° ìˆ˜(CUS_CN): ëšœë ·í•œ ìš°í•˜í–¥ ì¶”ì„¸ì…ë‹ˆë‹¤.",
              "ì‹ ê·œ ê³ ê° ë¹„ìœ¨(NEW_RAT): ë§¤ìš° ë‚®ì€ ìˆ˜ì¤€ì— ë¨¸ë¬¼ëŸ¬ ìˆìŠµë‹ˆë‹¤.",
              "ì¬ë°©ë¬¸ìœ¨(REU_RAT): ì§€ì†ì ìœ¼ë¡œ í•˜ë½í•˜ê³  ìˆìŠµë‹ˆë‹¤."
          ],
          "interpretation": "ê²½ìŸë ¥ì„ ìƒê³  ìˆëŠ” ìœ„í—˜ ì‹ í˜¸ ê·¸ë£¹ì…ë‹ˆë‹¤. ì‹ ê·œ ê³ ê° ìœ ì¹˜ì— ì‹¤íŒ¨í•˜ê³  ìˆìœ¼ë©°, ê¸°ì¡´ì˜ ì¶©ì„± ê³ ê°ë§ˆì € ìƒì–´ê°€ê³  ìˆì–´ ì‹¤ì ì´ ì§€ì†ì ìœ¼ë¡œ ì•…í™”ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì ê·¹ì ì¸ ê°œì…ì´ í•„ìš”í•œ ê·¸ë£¹ì…ë‹ˆë‹¤.",
          "key_industries": "ì»¤í”¼ì „ë¬¸ì , ì¹´í˜ ë“± ê²½ìŸì´ ë§¤ìš° ì¹˜ì—´í•œ ì—…ì¢…ì´ ë§ìŠµë‹ˆë‹¤. ì´ëŠ” ë™ì¼ ì—…ì¢… ë‚´ì—ì„œë„ ì„±ì¥í•˜ëŠ” ê·¸ë£¹(Cluster 0)ê³¼ ì‡ í‡´í•˜ëŠ” ê·¸ë£¹ì´ ëª…í™•íˆ ë‚˜ë‰¨ì„ ë³´ì—¬ì¤ë‹ˆë‹¤."},
    "3": {"name": "ì €í™œì„±/ìœ ì§€ ê·¸ë£¹", "tone": "stay", "icon": "ğŸŒ±",
          "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.",
          "pattern": [
              "ë§¤ì¶œ(SAA) ë° ê³ ê° ìˆ˜(CUS_CN): ê°€ì¥ ë‚®ì€ ìˆ˜ì¤€ì—ì„œ í° ë³€í™” ì—†ì´ ìœ ì§€ë©ë‹ˆë‹¤.",
              "ì‹ ê·œ ê³ ê° ë¹„ìœ¨/ì¬ë°©ë¬¸ìœ¨: ëª¨ë‘ ë‚®ì€ ìˆ˜ì¤€ì—ì„œ ì •ì²´ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
          ],
          "interpretation": "ì†Œê·œëª¨ í˜„ìƒ ìœ ì§€ ê·¸ë£¹ì…ë‹ˆë‹¤. ì„±ì¥ì„ ìœ„í•œ ë™ë ¥ì„ ì°¾ì§€ ëª»í•˜ê³  ìˆìœ¼ë‚˜, ë™ì‹œì— ê¸‰ê²©í•œ ì‹¤ì  ì•…í™”ë„ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤. ì†Œìˆ˜ì˜ ê³ ì • ê³ ê°ì— ì˜ì¡´í•˜ê±°ë‚˜, ì‚¬ì—… ê·œëª¨ê°€ ë§¤ìš° ì‘ì€ ìƒì ë“¤ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.",
          "key_industries": "ì–‘ì‹, ì¤‘ì‹ ë“± ë‹¤ì–‘í•œ ì—…ì¢…ì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, íŠ¹ì • ì—…ì¢…ë³´ë‹¤ëŠ” ì‚¬ì—…ì˜ ê·œëª¨ ìì²´ê°€ ì‘ì€ ê³³ë“¤ì´ ì´ ê·¸ë£¹ì— ì†í•  ê²ƒìœ¼ë¡œ ì¶”ì •ë©ë‹ˆë‹¤."},
}

@lru_cache(maxsize=1)
def load_dtw_table() -> pd.DataFrame:
    base_dir = os.path.dirname(FIXED_DATA_PATH)
    csv_path = os.path.join(base_dir, DTW_REL_PATH)
    df = pd.read_csv(csv_path, encoding="euc-kr")
    df["ENCODED_MCT"] = df["ENCODED_MCT"].astype(str)
    df["dtw_cluster"] = df["dtw_cluster"].astype(str)
    return df

def get_dtw_cluster(mct_id: str) -> str | None:
    if not mct_id:
        return None
    df = load_dtw_table()
    row = df.loc[df["ENCODED_MCT"] == str(mct_id)]
    return None if row.empty else row.iloc[0]["dtw_cluster"]

def build_dtw_report(mct_id: str, merchant_name: str) -> dict:
    dtw = load_dtw_table()
    my_cluster = get_dtw_cluster(mct_id)
    label = DTW_LABELS.get(str(my_cluster), {
        "name": "ë¯¸ì •", "tone": "secondary", "icon": "â„¹ï¸",
        "intro": "DTW ê¸°ë°˜ íŒ¨í„´ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.",
        "pattern": ["êµ°ì§‘ ë¼ë²¨ ë§¤í•‘ ì¤€ë¹„ ì¤‘"],
        "interpretation": "ì¶”ê°€ ë°ì´í„° í•„ìš”.",
        "key_industries": "-"
    })


    intro_title = "ì„±ë™êµ¬ë‚´ ì—…ì¥ê³¼ ë‚´ ì—…ì¥ ë¹„êµë¶„ì„ ì„œë¹„ìŠ¤ â¤ï¸"
    intro_body = (
        "ì„±ë™êµ¬ ë‚´ì—ì„œ ë§¤ì¶œ, ê³ ê° ìˆ˜ ë“± ë³€í™” íŒ¨í„´ì´ ë¹„ìŠ·í•œ ê·¸ë£¹ë“¤ì„ ë¹„êµë¶„ì„í•œ ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦´ê²Œìš”. ğŸ˜‹<br>"
        f"ì ì£¼ë‹˜ì˜ ì—…ì¥ì€ ì„±ë™êµ¬ ë‚´ì—ì„œ <b>[{label['name']}]</b>ì— í•´ë‹¹í•˜ë„¤ìš”!"
    )
    return {
        "intro_title": intro_title,
        "intro_body": intro_body,
        "cluster_badge": {"name": label["name"], "tone": label["tone"], "icon": label["icon"]},
        "notes": "DTW ê¸°ë°˜ Clustering ê²°ê³¼ ì œì‹œ",
        "pattern": label["pattern"],
        "interpretation": label["interpretation"],
        "key_industries": label["key_industries"],
        "meta": {"model_ver": "dtw_v1", "data_source": DTW_REL_PATH}
    }
